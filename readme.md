<!-- Code generated by gomarkdoc. DO NOT EDIT -->

# go\-redis\-bucket

```go
import "github.com/plsmphnx/go-redis-bucket"
```

A Redis\-backed rate limiter, based on the leaky\-bucket algorithm, implemented using a purely EVAL\-based solution.

```go
package main

import (
	"context"
	"net/http"
	"strconv"
	"time"

	"github.com/go-redis/redis/v8"
	limiter "github.com/plsmphnx/go-redis-bucket"
)

func main() {
	// Create a Redis client with appropriate configuration and error handling.
	r := redis.NewClient(&redis.Options{})

	// Create a limiter that restricts calls to 10-20 per minute.
	l, err := limiter.NewLimiter(limiter.Config{
		Redis: Redis{r},
		Buckets: []limiter.Bucket{
			limiter.Capacity{Window: time.Minute, Min: 10, Max: 20},
		},
	})
	if err != nil {
		panic(err)
	}

	// Simple handler, expects a "user" query parameter to identify callers.
	http.HandleFunc("/", func(w http.ResponseWriter, r *http.Request) {
		res, err := l.Test(r.Context(), r.URL.Query().Get("user"), 1)
		switch {
		case err != nil:
			w.WriteHeader(http.StatusInternalServerError)
		case !res.Allow:
			w.WriteHeader(http.StatusTooManyRequests)
			w.Header().Set("Retry-After", strconv.Itoa(int(res.Wait.Seconds())))
		default:
			w.WriteHeader(http.StatusOK)
		}
	})
	http.ListenAndServe(":80", nil)
}

type Redis struct{ *redis.Client }

func (r Redis) Eval(ctx context.Context, script string, keys []string, args []any) (any, error) {
	return r.Client.Eval(ctx, script, keys, args...).Result()
}

func (r Redis) EvalSha(ctx context.Context, sha string, keys []string, args []any) (any, error) {
	return r.Client.EvalSha(ctx, sha, keys, args...).Result()
}
```

## Index

- [type Backoff](<#type-backoff>)
- [type Bucket](<#type-bucket>)
- [type Capacity](<#type-capacity>)
  - [func (c Capacity) Rate() (float64, float64)](<#func-capacity-rate>)
- [type Config](<#type-config>)
- [type Constant](<#type-constant>)
  - [func (c Constant) Backoff(value float64) float64](<#func-constant-backoff>)
- [type Eval](<#type-eval>)
- [type EvalSha](<#type-evalsha>)
- [type Exponential](<#type-exponential>)
  - [func (e Exponential) Backoff(value float64) float64](<#func-exponential-backoff>)
- [type Limiter](<#type-limiter>)
  - [func NewLimiter(c Config) (*Limiter, error)](<#func-newlimiter>)
  - [func (l *Limiter) Test(ctx context.Context, key string, cost float64) (Result, error)](<#func-limiter-test>)
- [type Linear](<#type-linear>)
  - [func (l Linear) Backoff(value float64) float64](<#func-linear-backoff>)
- [type Power](<#type-power>)
  - [func (p Power) Backoff(value float64) float64](<#func-power-backoff>)
- [type Rate](<#type-rate>)
  - [func (r Rate) Rate() (float64, float64)](<#func-rate-rate>)
- [type Result](<#type-result>)


## type [Backoff](<https://github.com/plsmphnx/go-redis-bucket/blob/main/backoff.go#L10-L12>)

Backoff represents a scaling backoff function for repeated denials.

```go
type Backoff interface {
    Backoff(float64) float64
}
```

## type [Bucket](<https://github.com/plsmphnx/go-redis-bucket/blob/main/bucket.go#L11-L13>)

Bucket represents a single set of rate\-limiting parameters that can be described with leaky\-bucket flow \(per second\) and burst values.

```go
type Bucket interface {
    Rate() (flow float64, burst float64)
}
```

## type [Capacity](<https://github.com/plsmphnx/go-redis-bucket/blob/main/bucket.go#L29-L42>)

Capacity describes a bucket using a minimum and maximum over a window.

```go
type Capacity struct {
    // Window is the time window over which these limits are considered.
    Window time.Duration

    // Min is the minimum capacity that is guaranteed over this time window,
    // assuming a perfectly uniform call pattern.
    Min float64

    // Max is the maximum capacity that the system can handle over this
    // time window. This value is absolute; callers will be limited to
    // enforce this. It must be sufficiently greater than the minimum
    // capacity to cover the highest cost which will be tested.
    Max float64
}
```

### func \(Capacity\) [Rate](<https://github.com/plsmphnx/go-redis-bucket/blob/main/bucket.go#L51>)

```go
func (c Capacity) Rate() (float64, float64)
```

Rate returns the flow and burst parameters for a Capacity bucket.

## type [Config](<https://github.com/plsmphnx/go-redis-bucket/blob/main/limiter.go#L16-L28>)

Config provides configuration values for creating a new rate\-limiter.

```go
type Config struct {
    // Redis is the Redis client for this rate-limiter.
    Redis Eval

    // Prefix is a string that will be added to the beginning of all keys.
    Prefix string

    // Backoff is the backoff scaling function (default 2x linear).
    Backoff Backoff

    // Buckets are the rate-limiting metrics.
    Buckets []Bucket
}
```

## type [Constant](<https://github.com/plsmphnx/go-redis-bucket/blob/main/backoff.go#L15>)

Constant represents a constant backoff factor.

```go
type Constant float64
```

### func \(Constant\) [Backoff](<https://github.com/plsmphnx/go-redis-bucket/blob/main/backoff.go#L28>)

```go
func (c Constant) Backoff(value float64) float64
```

Backoff computes a constant backoff value.

## type [Eval](<https://github.com/plsmphnx/go-redis-bucket/blob/main/redis.go#L14-L16>)

Eval represents a Redis client supporting EVAL.

```go
type Eval interface {
    Eval(ctx context.Context, script string, keys []string, args []any) (any, error)
}
```

## type [EvalSha](<https://github.com/plsmphnx/go-redis-bucket/blob/main/redis.go#L19-L21>)

EvalSha represents a Redis client supporting EVALSHA.

```go
type EvalSha interface {
    EvalSha(ctx context.Context, sha string, keys []string, args []any) (any, error)
}
```

## type [Exponential](<https://github.com/plsmphnx/go-redis-bucket/blob/main/backoff.go#L24>)

Exponential represents an exponential backoff factor.

```go
type Exponential float64
```

### func \(Exponential\) [Backoff](<https://github.com/plsmphnx/go-redis-bucket/blob/main/backoff.go#L43>)

```go
func (e Exponential) Backoff(value float64) float64
```

Backoff computes an exponential backoff value.

## type [Limiter](<https://github.com/plsmphnx/go-redis-bucket/blob/main/limiter.go#L31-L36>)

Limiter provides a single rate\-limiter instance.

```go
type Limiter struct {
    // contains filtered or unexported fields
}
```

### func [NewLimiter](<https://github.com/plsmphnx/go-redis-bucket/blob/main/limiter.go#L52>)

```go
func NewLimiter(c Config) (*Limiter, error)
```

NewLimiter creates a new rate\-limiter instance.

### func \(\*Limiter\) [Test](<https://github.com/plsmphnx/go-redis-bucket/blob/main/limiter.go#L101>)

```go
func (l *Limiter) Test(ctx context.Context, key string, cost float64) (Result, error)
```

Test whether the given action should be allowed according to the rate limits.

## type [Linear](<https://github.com/plsmphnx/go-redis-bucket/blob/main/backoff.go#L18>)

Linear represents a linear backoff factor.

```go
type Linear float64
```

### func \(Linear\) [Backoff](<https://github.com/plsmphnx/go-redis-bucket/blob/main/backoff.go#L33>)

```go
func (l Linear) Backoff(value float64) float64
```

Backoff computes a linear backoff value.

## type [Power](<https://github.com/plsmphnx/go-redis-bucket/blob/main/backoff.go#L21>)

Power represents a power backoff factor.

```go
type Power float64
```

### func \(Power\) [Backoff](<https://github.com/plsmphnx/go-redis-bucket/blob/main/backoff.go#L38>)

```go
func (p Power) Backoff(value float64) float64
```

Backoff computes a power backoff value.

## type [Rate](<https://github.com/plsmphnx/go-redis-bucket/blob/main/bucket.go#L16-L26>)

Rate describes a bucket using raw flow \(per second\) and burst values.

```go
type Rate struct {
    // Flow is the rate at which capacity becomes available, per second. In
    // a fully-stressed system, calls will be limited to exactly this rate.
    Flow float64

    // Burst is the amount of leeway in capacity the system can support.
    // This is the amount of capacity that can be utilized before rate-
    // limiting is applied. It must be at least equal to the highest cost
    // which will be tested.
    Burst float64
}
```

### func \(Rate\) [Rate](<https://github.com/plsmphnx/go-redis-bucket/blob/main/bucket.go#L46>)

```go
func (r Rate) Rate() (float64, float64)
```

Rate returns the flow and burst parameters for a Rate bucket.

## type [Result](<https://github.com/plsmphnx/go-redis-bucket/blob/main/limiter.go#L39-L48>)

Result provides the result of a rate\-limiting test.

```go
type Result struct {
    // Allow indicates whether the request should be allowed.
    Allow bool

    // Free indicates the remaining capacity before calls will be rejected.
    Free float64

    // Wait indicates how long the caller should wait before trying again.
    Wait time.Duration
}
```

## Contributing

This project has adopted the
[Microsoft Open Source Code of Conduct](https://opensource.microsoft.com/codeofconduct/).
For more information see the
[Code of Conduct FAQ](https://opensource.microsoft.com/codeofconduct/faq/) or
contact [opencode@microsoft.com](mailto:opencode@microsoft.com) with any
additional questions or comments.

Generated by [gomarkdoc](<https://github.com/princjef/gomarkdoc>)
