<!-- Code generated by gomarkdoc. DO NOT EDIT -->

# limiter

```go
import "github.com/plsmphnx/go-redis-bucket"
```

A Redis\-backed rate limiter, based on the leaky\-bucket algorithm, implemented using a purely EVAL\-based solution.

```go
package main

import (
	"context"
	"net/http"
	"strconv"
	"time"

	"github.com/go-redis/redis/v8"
	limiter "github.com/plsmphnx/go-redis-bucket"
)

func main() {
	// Create a Redis client with appropriate configuration and error handling.
	r := redis.NewClient(&redis.Options{})

	// Create a limiter that restricts calls to 10-20 per minute.
	l, err := limiter.New(Redis{r}, limiter.Capacity{Window: time.Minute, Min: 10, Max: 20})
	if err != nil {
		panic(err)
	}

	// Simple handler, expects a "user" query parameter to identify callers.
	http.HandleFunc("/", func(w http.ResponseWriter, r *http.Request) {
		res, err := l.Test(r.Context(), r.URL.Query().Get("user"), 1)
		switch {
		case err != nil:
			w.WriteHeader(http.StatusInternalServerError)
		case !res.Allow:
			w.WriteHeader(http.StatusTooManyRequests)
			w.Header().Set("Retry-After", strconv.Itoa(int(res.Wait.Seconds())))
		default:
			w.WriteHeader(http.StatusOK)
		}
	})
	http.ListenAndServe(":80", nil)
}

type Redis struct{ *redis.Client }

func (r Redis) Eval(ctx context.Context, script string, keys []string, args []any) (any, error) {
	return r.Client.Eval(ctx, script, keys, args...).Result()
}

func (r Redis) EvalSha(ctx context.Context, sha string, keys []string, args []any) (any, error) {
	return r.Client.EvalSha(ctx, sha, keys, args...).Result()
}
```

## Index

- [type Bucket](<#type-bucket>)
- [type Capacity](<#type-capacity>)
  - [func (c Capacity) Rate() (float64, float64)](<#func-capacity-rate>)
- [type Config](<#type-config>)
  - [func WithAdditionalBucket(bucket Bucket) Config](<#func-withadditionalbucket>)
  - [func WithConstantBackoff(factor float64) Config](<#func-withconstantbackoff>)
  - [func WithCustomBackoff(backoff func(float64) float64) Config](<#func-withcustombackoff>)
  - [func WithExponentialBackoff(factor float64) Config](<#func-withexponentialbackoff>)
  - [func WithLinearBackoff(factor float64) Config](<#func-withlinearbackoff>)
  - [func WithPowerBackoff(factor float64) Config](<#func-withpowerbackoff>)
  - [func WithPrefix(prefix string) Config](<#func-withprefix>)
- [type Eval](<#type-eval>)
- [type EvalSha](<#type-evalsha>)
- [type Limiter](<#type-limiter>)
  - [func New(redis Eval, bucket Bucket, configs ...Config) (*Limiter, error)](<#func-new>)
  - [func (l *Limiter) Test(ctx context.Context, key string, cost float64) (Result, error)](<#func-limiter-test>)
- [type Rate](<#type-rate>)
  - [func (r Rate) Rate() (float64, float64)](<#func-rate-rate>)
- [type Result](<#type-result>)


## type [Bucket](<https://github.com/plsmphnx/go-redis-bucket/blob/main/bucket.go#L11-L13>)

Bucket represents a single set of rate\-limiting parameters that can be described with leaky\-bucket flow \(per second\) and burst values.

```go
type Bucket interface {
    Rate() (flow float64, burst float64)
}
```

## type [Capacity](<https://github.com/plsmphnx/go-redis-bucket/blob/main/bucket.go#L29-L42>)

Capacity describes a bucket using a minimum and maximum over a window.

```go
type Capacity struct {
    // Window is the time window over which these limits are considered.
    Window time.Duration

    // Min is the minimum capacity that is guaranteed over this time window,
    // assuming a perfectly uniform call pattern.
    Min float64

    // Max is the maximum capacity that the system can handle over this
    // time window. This value is absolute; callers will be limited to
    // enforce this. It must be sufficiently greater than the minimum
    // capacity to cover the highest cost which will be tested.
    Max float64
}
```

### func \(Capacity\) [Rate](<https://github.com/plsmphnx/go-redis-bucket/blob/main/bucket.go#L51>)

```go
func (c Capacity) Rate() (float64, float64)
```

Rate returns the flow and burst parameters for a Capacity bucket.

## type [Config](<https://github.com/plsmphnx/go-redis-bucket/blob/main/limiter.go#L16>)

Config provides configuration values for creating a new rate\-limiter.

```go
type Config func(*config)
```

### func [WithAdditionalBucket](<https://github.com/plsmphnx/go-redis-bucket/blob/main/bucket.go#L56>)

```go
func WithAdditionalBucket(bucket Bucket) Config
```

WithAdditionalBucket adds an additional rate\-limiting bucket to the limiter.

### func [WithConstantBackoff](<https://github.com/plsmphnx/go-redis-bucket/blob/main/backoff.go#L9>)

```go
func WithConstantBackoff(factor float64) Config
```

WithConstantBackoff applies a constant backoff to the limiter.

### func [WithCustomBackoff](<https://github.com/plsmphnx/go-redis-bucket/blob/main/backoff.go#L37>)

```go
func WithCustomBackoff(backoff func(float64) float64) Config
```

WithCustomBackoff applies a custom backoff to the limiter.

### func [WithExponentialBackoff](<https://github.com/plsmphnx/go-redis-bucket/blob/main/backoff.go#L30>)

```go
func WithExponentialBackoff(factor float64) Config
```

WithExponentialBackoff applies an exponential backoff to the limiter.

### func [WithLinearBackoff](<https://github.com/plsmphnx/go-redis-bucket/blob/main/backoff.go#L16>)

```go
func WithLinearBackoff(factor float64) Config
```

WithLinearBackoff applies a linear backoff to the limiter.

### func [WithPowerBackoff](<https://github.com/plsmphnx/go-redis-bucket/blob/main/backoff.go#L23>)

```go
func WithPowerBackoff(factor float64) Config
```

WithPowerBackoff applies a power backoff to the limiter.

### func [WithPrefix](<https://github.com/plsmphnx/go-redis-bucket/blob/main/limiter.go#L46>)

```go
func WithPrefix(prefix string) Config
```

WithPrefix adds the given string to the beginning of all keys.

## type [Eval](<https://github.com/plsmphnx/go-redis-bucket/blob/main/redis.go#L14-L16>)

Eval represents a Redis client supporting EVAL.

```go
type Eval interface {
    Eval(ctx context.Context, script string, keys []string, args []any) (any, error)
}
```

## type [EvalSha](<https://github.com/plsmphnx/go-redis-bucket/blob/main/redis.go#L19-L21>)

EvalSha represents a Redis client supporting EVALSHA.

```go
type EvalSha interface {
    EvalSha(ctx context.Context, sha string, keys []string, args []any) (any, error)
}
```

## type [Limiter](<https://github.com/plsmphnx/go-redis-bucket/blob/main/limiter.go#L25-L30>)

Limiter provides a single rate\-limiter instance.

```go
type Limiter struct {
    // contains filtered or unexported fields
}
```

### func [New](<https://github.com/plsmphnx/go-redis-bucket/blob/main/limiter.go#L51>)

```go
func New(redis Eval, bucket Bucket, configs ...Config) (*Limiter, error)
```

New creates a new rate\-limiter instance.

### func \(\*Limiter\) [Test](<https://github.com/plsmphnx/go-redis-bucket/blob/main/limiter.go#L92>)

```go
func (l *Limiter) Test(ctx context.Context, key string, cost float64) (Result, error)
```

Test whether the given action should be allowed according to the rate limits.

## type [Rate](<https://github.com/plsmphnx/go-redis-bucket/blob/main/bucket.go#L16-L26>)

Rate describes a bucket using raw flow \(per second\) and burst values.

```go
type Rate struct {
    // Flow is the rate at which capacity becomes available, per second. In
    // a fully-stressed system, calls will be limited to exactly this rate.
    Flow float64

    // Burst is the amount of leeway in capacity the system can support.
    // This is the amount of capacity that can be utilized before rate-
    // limiting is applied. It must be at least equal to the highest cost
    // which will be tested.
    Burst float64
}
```

### func \(Rate\) [Rate](<https://github.com/plsmphnx/go-redis-bucket/blob/main/bucket.go#L46>)

```go
func (r Rate) Rate() (float64, float64)
```

Rate returns the flow and burst parameters for a Rate bucket.

## type [Result](<https://github.com/plsmphnx/go-redis-bucket/blob/main/limiter.go#L33-L42>)

Result provides the result of a rate\-limiting test.

```go
type Result struct {
    // Allow indicates whether the request should be allowed.
    Allow bool

    // Free indicates the remaining capacity before calls will be rejected.
    Free float64

    // Wait indicates how long the caller should wait before trying again.
    Wait time.Duration
}
```

## Contributing

This project has adopted the
[Microsoft Open Source Code of Conduct](https://opensource.microsoft.com/codeofconduct/).
For more information see the
[Code of Conduct FAQ](https://opensource.microsoft.com/codeofconduct/faq/) or
contact [opencode@microsoft.com](mailto:opencode@microsoft.com) with any
additional questions or comments.


Generated by [gomarkdoc](<https://github.com/princjef/gomarkdoc>)
